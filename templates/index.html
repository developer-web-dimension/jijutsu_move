<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Jujutsu Trainer">
    <meta name="format-detection" content="telephone=no">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jujutsu Hand Sign Trainer</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
        }
        
        /* Top Progress Bar */
        .top-progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.2);
            z-index: 1000;
            display: none;
        }
        
        .top-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* Top Left Sign Preview */
        .top-sign-preview {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 999;
            background: rgba(0,0,0,0.7);
            border-radius: 10px;
            padding: 10px;
            display: none;
            max-width: 120px;
            backdrop-filter: blur(10px);
        }
        
        .top-sign-preview img {
            width: 100%;
            border-radius: 5px;
            margin-bottom: 8px;
        }
        
        .top-sign-preview .sign-info {
            text-align: center;
            font-size: 0.8em;
        }
        
        .top-sign-preview .sign-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .top-sign-preview .sign-accuracy {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            padding-top: 30px; /* Space for top elements */
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 400px;
            gap: 20px;
            align-items: start;
            justify-content: end;
            padding-right: 20px;
        }
        
        .video-section {
            display:none;
        }
        
        .side-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        #videoElement {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: -1;
            transform: scaleX(-1); /* Mirror the video for selfie mode */
            display: block; /* ADD THIS LINE */
        }
        
        #canvas {
            display: none;
        }
        
        .reference-image {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .reference-image img {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }
        
        .status-panel {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .accuracy-display {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .startup-screen {
            text-align: center;
            padding: 50px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin:15px;
        }
        
        .startup-screen h2 {
            font-size: 2em;
            margin-bottom: 20px;
        }
        
        .startup-screen p {
            font-size: 1.2em;
            margin-bottom: 30px;
            opacity: 0.8;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9em;
        }
        
        .info-item {
            background: rgba(255,255,255,0.1);
            padding: 8px;
            border-radius: 5px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transform: translateX(300px);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }
        
        .notification.error {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
        }
        
        .connection-status.connected {
            background: rgba(76, 175, 80, 0.8);
        }
        
        .connection-status.disconnected {
            background: rgba(244, 67, 54, 0.8);
        }

        .completion-screen {
            text-align: center;
            padding: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            margin: 20px;
            animation: slideInFromBottom 0.8s ease-out;
        }

        .completion-screen h1 {
            font-size: 3em;
            margin-bottom: 20px;
            color: #fff;
        }

        .celebration-emoji {
            font-size: 4em;
            margin: 20px 0;
        }

        .btn-restart {
            background: linear-gradient(45deg, #4ecdc4 0%, #44a08d 100%);
            color: white;
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
        
        /* Demo Video Styles */
        .demo-video-screen {
            text-align: center;
            padding: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            max-width: 800px;
            margin: 0 auto;
        }
        
        .demo-video-container h2 {
            font-size: 2em;
            margin-bottom: 15px;
            color: #4ecdc4;
        }
        
        .demo-video-container p {
            font-size: 1.1em;
            margin-bottom: 25px;
            opacity: 0.9;
        }
        
        .video-wrapper {
            position: relative;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            height: 300px;
        }
        
        #demoVideo {
            width: 100%;
            max-width: 600px;
            height: 300px;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .demo-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .demo-info {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .demo-info p {
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .demo-info ul {
            text-align: left;
            margin: 10px auto;
            display: inline-block;
            font-size: 0.95em;
            line-height: 1.6;
        }
        
        .demo-info li {
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .timer-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            font-size: 4em;
            font-weight: bold;
            padding: 30px 50px;
            border-radius: 20px;
            border: 3px solid #4ecdc4;
            z-index: 1001;
            backdrop-filter: blur(15px);
            text-align: center;
            min-width: 200px;
        }

        .timer-display.warning {
            border-color: #ffa726;
            color: #ffa726;
        }

        .timer-display.critical {
            border-color: #ff6b6b;
            color: #ff6b6b;
            animation: pulse 0.5s infinite alternate;
        }

        @keyframes pulse {
            from { transform: translate(-50%, -50%) scale(1); }
            to { transform: translate(-50%, -50%) scale(1.05); }
        }

        /* Results Summary Styles */
        .results-screen {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            margin: 20px;
            color: white;
        }

        .results-screen h2 {
            font-size: 2.5em;
            margin-bottom: 30px;
            color: #fff;
        }

        .scores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .score-item {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .score-item.lowest {
            background: rgba(255, 107, 107, 0.3);
            border: 2px solid #ff6b6b;
        }

        .score-sign-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .score-percentage {
            font-size: 2em;
            font-weight: bold;
        }

        .summary-stats {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .auto-mode-btn {
            background: linear-gradient(45deg, #4ecdc4 0%, #44a08d 100%);
            color: white;
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            font-weight: bold;
        }

        .auto-mode-btn:hover {
            transform: translateY(-2px);
        }

        

        /* HUD Overlay Styles */
        .hud-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 10;
            display: none;
        }

        .hud-overlay.active {
            display: block;
        }

        /* Top HUD Bar */
        .hud-top-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 8px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 0.9em;
        }

        .hud-progress-indicator {
            color: #4ecdc4;
            font-weight: bold;
        }

        .hud-sign-name {
            color: white;
            font-weight: bold;
        }

        /* Center Target Sign Display */
        .hud-target-sign {
            position: absolute;
            top: 30px;
            left: 30px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px;
            max-width: 200px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .hud-target-sign img {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .hud-target-title {
            color: #4ecdc4;
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 5px;
            text-align: center;
        }

        .hud-target-name {
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 8px;
        }

        /* Main Status HUD (Bottom Right) */
        .hud-status-panel {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 20px;
            min-width: 250px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .hud-accuracy-display {
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            color: #ff6b6b;
        }

        .hud-status-text {
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            color: white;
            margin-bottom: 15px;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .hud-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .hud-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        /* Stats Grid (Bottom Left) */
        .hud-stats-grid {
            position: absolute;
            bottom: 30px;
            left: 30px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            min-width: 280px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .hud-stat-item {
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
        }

        .hud-stat-label {
            font-size: 0.8em;
            color: #4ecdc4;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .hud-stat-value {
            font-size: 0.9em;
            color: white;
            font-weight: bold;
        }

        /* Controls HUD (Top Right) */
        .hud-controls {
            position: absolute;
            top: 30px;
            right: 30px;
            display: flex;
            gap: 10px;
            pointer-events: auto;
        }

        .hud-btn {
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .hud-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .hud-btn.danger {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .hud-btn.secondary {
            border-color: #4ecdc4;
            color: #4ecdc4;
        }


        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                justify-content: center;
                padding: 10px;
            }
            
            .side-panel {
                max-width: 400px;
                margin: 0 auto;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }



            @media (max-width: 768px) {
                .hud-target-sign {
                    max-width: 150px;
                    left: 15px;
                    top: 15px;
                    padding: 10px;
                }
                
                .hud-status-panel {
                    bottom: 15px;
                    right: 15px;
                    min-width: 200px;
                    padding: 15px;
                }
                
                .hud-accuracy-display {
                    font-size: 2.5em;
                }
                
                .hud-stats-grid {
                    bottom: 15px;
                    left: 15px;
                    min-width: 240px;
                    padding: 10px;
                    gap: 8px;
                }
                
                .hud-controls {
                    top: 15px;
                    right: 15px;
                    flex-direction: column;
                }
                
                .hud-top-bar {
                    top: 10px;
                    left: 15px;
                    right: 15px;
                    transform: none;
                    width: calc(100% - 30px);
                    justify-content: center;
                }
            }

            
            .demo-video-screen {
                padding: 4px;
            }
            
            .demo-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .demo-controls .btn {
                width: 200px;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <!-- Include Socket.IO client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
</head>
<body>
    <!-- Top Progress Bar -->
    <div id="topProgressBar" class="top-progress-bar">
        <div id="topProgressFill" class="top-progress-fill"></div>
    </div>
    
    <!-- Top Left Sign Preview -->
    <div id="topSignPreview" class="top-sign-preview">
        <img id="topSignImage" src="" alt="Current Sign">
        <div class="sign-info">
            <div id="topSignName" class="sign-name">Loading...</div>
            <div id="topSignAccuracy" class="sign-accuracy">0%</div>
        </div>
    </div>
    
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status disconnected">
        Connecting...
    </div>
    
    <div class="container">
        <div class="header">
        </div>
        
        <div id="startupScreen" class="startup-screen">
            <h2>Welcome to Jujutsu Hand Sign Training!</h2>
            <p>Master the ancient art of hand signs with AI-powered training</p>
            <button class="btn btn-primary" onclick="showDemoVideo()" style="font-size: 1.2em; padding: 15px 30px;">
                🎯 Manual Training
            </button>
        </div>
        
        <!-- Demo Video Screen -->
        <div id="demoVideoScreen" class="demo-video-screen" style="display: none;">
            <div class="demo-video-container">
                <h2> Training Demo</h2>
                <p>Watch this quick demo to learn how to use the hand sign trainer</p>
                
                <div class="video-wrapper">
                    <video id="demoVideo" autoplay muted  playsinline webkit-playsinline>
                        <source src="/static/vikas.mp4" type="video/mp4">
                        <p>Your browser doesn't support video playback. <button class="btn btn-primary" onclick="skipDemo()">Skip to Training</button></p>
                    </video>
                </div>
                
                <div class="demo-controls">
                    <button class="btn btn-secondary" onclick="skipDemo()">⏭ Skip Demo</button>
                    <button class="btn btn-primary" onclick="proceedToTraining()" style="display: none;" id="proceedButton">
                        Start Training Now
                    </button>
                </div>
                
            </div>
        </div>
        
        <div id="trainingInterface" class="main-content" style="display: none;">
            <!-- Hide the old side panel -->
            <div class="side-panel" style="display: none;">
                <!-- Keep existing content for fallback -->
                <div class="reference-image">
                    <h3>Target Sign</h3>
                    <div id="signName" style="font-size: 1.2em; margin-bottom: 10px;">Loading...</div>
                    <img id="referenceImage" src="" alt="Reference Sign" style="display: none;">
                    <div id="noImageText" style="padding: 50px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        No reference image available
                    </div>
                </div>

                <div id="timerDisplay" class="timer-display" style="display: none;">
                    <div id="timerNumber">5</div>
                    <div style="font-size: 0.3em; margin-top: 10px;">seconds remaining</div>
                </div>
                
                <div class="status-panel">
                    <h3>Training Status</h3>
                    <div class="accuracy-display" id="accuracyDisplay">0%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                    </div>
                    <div id="statusText" style="text-align: center; margin-top: 10px;">Position your hand</div>
                    
                    <div class="info-grid" style="margin-top: 15px;">
                        <div class="info-item">
                            <strong>Current:</strong> <span id="currentSign">-</span>
                        </div>
                        <div class="info-item">
                            <strong>Progress:</strong> <span id="progressText">0/0</span>
                        </div>
                        <div class="info-item">
                            <strong>Stability:</strong> <span id="stabilityText">0/5</span>
                        </div>
                        <div class="info-item">
                            <strong>Status:</strong> <span id="trainingStatus">Ready</span>
                        </div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-danger" onclick="stopTraining()">🛑 Stop</button>
                    <button class="btn btn-secondary" onclick="resetProgress()">🔄 Reset</button>
                </div>
            </div>
            
            <!-- Video elements -->
            <video id="videoElement" autoplay muted playsinline webkit-playsinline x-webkit-airplay="deny"></video>
            <canvas id="canvas"></canvas>
            
            <!-- NEW HUD OVERLAY -->
            <div id="hudOverlay" class="hud-overlay">
                <!-- Top Progress Bar -->
                <div class="hud-top-bar">
                    <div class="hud-progress-indicator">
                        <span id="hudProgressText">0/0</span> Signs Completed
                    </div>
                    <div class="hud-sign-name">
                        Current: <span id="hudCurrentSign">-</span>
                    </div>
                </div>
                
                <!-- Target Sign Display -->
                <div class="hud-target-sign">
                    <div class="hud-target-title">Target Sign</div>
                    <img id="hudTargetImage" src="" alt="Target Sign" style="display: none;">
                    <div id="hudNoImage" style="padding: 20px; text-align: center; color: #666;">
                        No image available
                    </div>
                    <div class="hud-target-name" id="hudTargetName">Loading...</div>
                </div>
                
                <!-- Main Status Panel -->
                <div class="hud-status-panel">
                    <div class="hud-accuracy-display" id="hudAccuracyDisplay">0%</div>
                    <div class="hud-status-text" id="hudStatusText">Position your hands</div>
                    <div class="hud-progress-bar">
                        <div class="hud-progress-fill" id="hudProgressFill" style="width: 0%;"></div>
                    </div>
                </div>
                
                <!-- Stats Grid -->
                <div class="hud-stats-grid">
                    <div class="hud-stat-item">
                        <div class="hud-stat-label">CURRENT</div>
                        <div class="hud-stat-value" id="hudStatCurrent">sign (1)</div>
                    </div>
                    <div class="hud-stat-item">
                        <div class="hud-stat-label">PROGRESS</div>
                        <div class="hud-stat-value" id="hudStatProgress">0/8</div>
                    </div>
                    <div class="hud-stat-item">
                        <div class="hud-stat-label">STABILITY</div>
                        <div class="hud-stat-value" id="hudStatStability">0/5</div>
                    </div>
                    <div class="hud-stat-item">
                        <div class="hud-stat-label">STATUS</div>
                        <div class="hud-stat-value" id="hudStatStatus">Ready</div>
                    </div>
                </div>
                
                <!-- Control Buttons -->
                <div class="hud-controls">
                    <button class="hud-btn danger" onclick="stopTraining()">🛑 Stop</button>
                    <button class="hud-btn secondary" onclick="resetProgress()">🔄 Reset</button>
                </div>
            </div>
            
            <div id="cameraError" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; padding: 50px; background: rgba(255,0,0,0.8); border-radius: 10px; z-index: 1000;">
                <h3>📷 Camera Error</h3>
                <p>Unable to access camera. Please check:</p>
                <ul style="text-align: left; margin: 20px 0;">
                    <li>Camera is connected and not used by other apps</li>
                    <li>Browser has camera permissions</li>
                    <li>Try refreshing the page</li>
                </ul>
                <button class="btn btn-secondary" onclick="initCamera()">Retry Camera</button>
            </div>
        </div>


        <!-- Completion Screen -->
        <div id="completionScreen" class="completion-screen" style="display: none;">
            <div class="celebration-emoji">🏆</div>
            <h2>Congratulations!</h2>
            <div class="completion-message">
                You have successfully mastered all the Jujutsu hand signs!
            </div>
            
            <div class="completion-actions">
                <button class="btn-restart" onclick="restartTraining()">
                    🔄 Train Again
                </button>
            </div>
        </div>
        <div id="resultsScreen" class="results-screen" style="display: none;">
            <h2>📊 Training Results</h2>
            
            <div class="summary-stats">
                <h3>Overall Performance</h3>
                <div id="averageScore" style="font-size: 2em; font-weight: bold; color: #4ecdc4;">0%</div>
                <p>Average Accuracy</p>
            </div>
            
            <div class="scores-grid" id="scoresGrid">
                <!-- Scores will be populated here -->
            </div>
            
            <div id="lowestSignInfo" class="summary-stats" style="background: rgba(255, 107, 107, 0.2);">
                <h3>🎯 Sign to Practice More</h3>
                <div id="lowestSignName" style="font-size: 1.5em; font-weight: bold;">-</div>
                <div id="lowestSignScore" style="font-size: 2em; font-weight: bold; color: #ff6b6b;">0%</div>
                <p>Lowest scoring sign</p>
            </div>
            
            <div style="margin-top: 30px;">
                <button class="btn-restart" onclick="restartTraining()">🔄 Train Again</button>
                <button class="btn-restart" onclick="goHome()" style="background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);">🏠 Home</button>
            </div>
        </div>

    </div>
    
    <div id="notification" class="notification"></div>
    
    <script>
        // Initialize Socket.IO connection
        // const socket = io();
        const socket = io({
            transports: ['websocket', 'polling'], // Allow fallback
            timeout: 30000, // Increased timeout for iOS
            forceNew: true,
            reconnection: true,
            reconnectionDelay: 2000, // Longer delay for iOS
            reconnectionAttempts: 10,
            maxReconnectionAttempts: 15,
            upgrade: true,
            rememberUpgrade: false
        });
        
        let videoElement = null;
        let canvas = null;
        let ctx = null;
        let frameProcessingInterval = null;
        let isTrainingActive = false;
        let timerInterval = null;
        let isAutoMode = false;
        let signTimer = null;
        let currentSignStartTime = null;
        let timeRemaining = 5;

        // Connection status handlers
        socket.on('connect', function() {
            console.log('Connected to server');
            document.getElementById('connectionStatus').textContent = 'Connected';
            document.getElementById('connectionStatus').className = 'connection-status connected';
        });
        
        socket.on('disconnect', function() {
            console.log('Disconnected from server');
            document.getElementById('connectionStatus').textContent = 'Disconnected';
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
        });
        

        socket.on('sign_auto_advanced', function(data) {
            if (data.training_complete) {
                showNotification('Training Complete! All signs mastered!', 'success');
                showCompletionScreen();
            } else {
                showNotification(`Advanced to: ${data.next_sign}`, 'success');
                // Start timer for next sign
                startSignTimer();
            }
        });

        
        // REPLACE the existing socket.on('training_response', function(data) { ... });
        socket.on('training_response', function(data) {
            if (data.success) {
                if (data.message.includes('started')) {
                    document.getElementById('startupScreen').style.display = 'none';
                    document.getElementById('trainingInterface').style.display = 'grid';
                    
                    // Show top elements
                    document.getElementById('topProgressBar').style.display = 'block';
                    document.getElementById('topSignPreview').style.display = 'block';
                    
                    isTrainingActive = true;
                    
                    // Start the first sign timer
                    startSignTimer();
                    
                    // Start periodic status updates
                    setInterval(() => {
                        if (isTrainingActive) {
                            socket.emit('get_status');
                            socket.emit('get_current_sign_image');
                        }
                    }, 500);
                    
                    // Start frame processing
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                    const frameRate = isIOS ? 200 : 100;
                    frameProcessingInterval = setInterval(captureAndSendFrame, frameRate);
                    
                    showNotification('Training started!');
                } else if (data.message.includes('stopped')) {
                    // Clear timer when stopping
                    if (signTimer) {
                        clearInterval(signTimer);
                        signTimer = null;
                    }
                    document.getElementById('timerDisplay').style.display = 'none';
                    
                    document.getElementById('startupScreen').style.display = 'block';
                    document.getElementById('trainingInterface').style.display = 'none';
                    document.getElementById('demoVideoScreen').style.display = 'none';
                    
                    // Hide top elements
                    document.getElementById('topProgressBar').style.display = 'none';
                    document.getElementById('topSignPreview').style.display = 'none';
                    
                    isTrainingActive = false;
                    
                    // Stop camera
                    if (videoElement && videoElement.srcObject) {
                        const tracks = videoElement.srcObject.getTracks();
                        tracks.forEach(track => track.stop());
                        videoElement.srcObject = null;
                    }
                    
                    // Clear intervals
                    if (frameProcessingInterval) {
                        clearInterval(frameProcessingInterval);
                        frameProcessingInterval = null;
                    }
                    
                    // Reset demo video
                    const demoVideo = document.getElementById('demoVideo');
                    demoVideo.pause();
                    demoVideo.currentTime = 0;
                    document.getElementById('proceedButton').style.display = 'none';
                    
                    showNotification('Training stopped!');
                }
            } else {
                showNotification(data.message, 'error');
            }
        });
        
        socket.on('frame_result', function(data) {
            if (data.success) {
                // Update real-time accuracy in UI
                updateInstantFeedback(data);
                
                if (data.training_complete) {
                    showNotification('Training Complete! All signs mastered!', 'success');
                    showCompletionScreen();

                } else if (data.sign_completed) {
                    showNotification('Sign completed! Moving to next...', 'success');
                }
            }
        });
        
        socket.on('status_update', function(data) {
            // Update main UI
            document.getElementById('accuracyDisplay').textContent = `${data.accuracy.toFixed(1)}%`;
            document.getElementById('statusText').textContent = data.status;
            document.getElementById('currentSign').textContent = data.current_sign || 'Complete';
            document.getElementById('progressText').textContent = `${data.completed_count}/${data.total_signs}`;
            document.getElementById('stabilityText').textContent = `${data.stable_detections}/${data.required_detections}`;
            
            // Update progress bars
            const progressPercent = (data.completed_count / data.total_signs) * 100;
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
            document.getElementById('topProgressFill').style.width = `${progressPercent}%`;
            
            // Update top sign preview
            document.getElementById('topSignName').textContent = data.current_sign || 'Complete';
            document.getElementById('topSignAccuracy').textContent = `${data.accuracy.toFixed(1)}%`;
            
            // Update accuracy colors
            const accuracyElement = document.getElementById('accuracyDisplay');
            const topAccuracyElement = document.getElementById('topSignAccuracy');

            if (data.training_complete && isTrainingActive) {
                setTimeout(() => {
                    showCompletionScreen();
                }, 1000);
            }

            
            let color;
            if (data.accuracy >= 65) {
                color = '#4ecdc4';
            } else if (data.accuracy >= 45) {
                color = '#ffa726';
            } else {
                color = '#ff6b6b';
            }
            
            accuracyElement.style.color = color;
            topAccuracyElement.style.color = color;
        });
        
        socket.on('sign_image_update', function(data) {
            const imgElement = document.getElementById('referenceImage');
            const noImageElement = document.getElementById('noImageText');
            const signNameElement = document.getElementById('signName');
            const topSignImage = document.getElementById('topSignImage');
            
            if (data.image) {
                // Update main reference image
                imgElement.src = `data:image/jpeg;base64,${data.image}`;
                imgElement.style.display = 'block';
                noImageElement.style.display = 'none';
                
                // Update top sign preview image
                topSignImage.src = `data:image/jpeg;base64,${data.image}`;
            } else {
                imgElement.style.display = 'none';
                noImageElement.style.display = 'block';
                
                // Clear top sign preview image
                topSignImage.src = '';
            }
            
            signNameElement.textContent = data.sign_name || 'Training Complete';
        });
        
        socket.on('sign_changed', function(data) {
            showNotification(data.message);
            socket.emit('get_current_sign_image');
        });
        
        socket.on('progress_reset', function(data) {
            showNotification(data.message);
            socket.emit('get_current_sign_image');
        });
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Add this new function
        function updateTimerDisplay() {
            const timerDisplay = document.getElementById('timerDisplay');
            const timerNumber = document.getElementById('timerNumber');
            
            if (timeRemaining > 0) {
                timerDisplay.style.display = 'block';
                timerNumber.textContent = timeRemaining;
                
                // Style changes based on time remaining
                timerDisplay.className = 'timer-display';
                if (timeRemaining <= 2) {
                    timerDisplay.classList.add('critical');
                } else if (timeRemaining <= 3) {
                    timerDisplay.classList.add('warning');
                }
            } else {
                timerDisplay.style.display = 'none';
            }
        }

        // Add this new function
        function startSignTimer() {
            // Clear any existing timer
            if (signTimer) {
                clearInterval(signTimer);
            }
            
            timeRemaining = 5;
            currentSignStartTime = Date.now();
            
            // Update timer display immediately
            updateTimerDisplay();
            
            // Start countdown timer
            signTimer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(signTimer);
                    signTimer = null;
                    
                    // Auto-advance to next sign
                    socket.emit('auto_advance_sign');
                }
            }, 1000);
        }

        
        function showDemoVideo() {
            // Hide startup screen and show demo video
            document.getElementById('startupScreen').style.display = 'none';
            document.getElementById('demoVideoScreen').style.display = 'block';
            
            const demoVideo = document.getElementById('demoVideo');
            const proceedButton = document.getElementById('proceedButton');
            
            // Show proceed button when video ends
            demoVideo.addEventListener('ended', function() {
                proceedButton.style.display = 'inline-block';
                showNotification('Demo complete! Ready to start training? 🎬');
            });
            
            // Auto-play the demo video
            demoVideo.play().catch(error => {
                console.log('Auto-play failed:', error);
                showNotification('Click play to watch the demo video 📹', 'error');
            });
            
            showNotification('Watching training demo... ⏯️');
        }

        // REPLACE the existing showCompletionScreen function
        function showCompletionScreen() {
            // Stop training but don't go to home
            isTrainingActive = false;
            
            // Clear timer
            if (signTimer) {
                clearInterval(signTimer);
                signTimer = null;
            }
            document.getElementById('timerDisplay').style.display = 'none';
            
            // Stop camera and intervals
            if (videoElement && videoElement.srcObject) {
                const tracks = videoElement.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                videoElement.srcObject = null;
            }
            
            if (frameProcessingInterval) {
                clearInterval(frameProcessingInterval);
                frameProcessingInterval = null;
            }
            
            // Hide training interface and show completion screen
            document.getElementById('trainingInterface').style.display = 'none';
            document.getElementById('topProgressBar').style.display = 'none';
            document.getElementById('topSignPreview').style.display = 'none';
            document.getElementById('completionScreen').style.display = 'block';
            
            showNotification('🎉 All hand signs completed! 🥷', 'success');
        }

        function restartTraining() {
            // Hide completion screen
            document.getElementById('completionScreen').style.display = 'none';
            
            // Reset progress on server
            socket.emit('reset_progress');
            
            // Start training again
            setTimeout(() => {
                startTraining();
            }, 1000);
        }

        
        function skipDemo() {
            showNotification('Demo skipped! Starting training... ⏭️');
            proceedToTraining();
        }
        
        function proceedToTraining() {
            // Hide demo screen
            document.getElementById('demoVideoScreen').style.display = 'none';
            
            // Pause and reset demo video
            const demoVideo = document.getElementById('demoVideo');
            demoVideo.pause();
            demoVideo.currentTime = 0;
            
            // Start the actual training
            startTraining();
        }
        
        async function initCamera() {
            try {
                videoElement = document.getElementById('videoElement');
                canvas = document.getElementById('canvas');
                
                if (!videoElement || !canvas) {
                    throw new Error('Video or canvas element not found');
                }
                
                ctx = canvas.getContext('2d');
                
                // iOS-compatible video constraints
                const constraints = {
                    video: {
                        width: { ideal: 640, max: 1280 },
                        height: { ideal: 480, max: 720 },
                        facingMode: 'user', // Front camera
                        frameRate: { ideal: 30, max: 30 }
                    },
                    audio: false
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                videoElement.srcObject = stream;
                
                // iOS requires explicit play() call and user interaction
                videoElement.muted = true;
                videoElement.playsInline = true; // Critical for iOS
                videoElement.autoplay = true;
                
                // Wait for video to be ready
                await new Promise((resolve) => {
                    videoElement.onloadedmetadata = () => {
                        resolve();
                    };
                });
                
                // Explicitly play for iOS
                await videoElement.play();
                
                const cameraError = document.getElementById('cameraError');
                if (cameraError) {
                    cameraError.style.display = 'none';
                }
                
                // Set canvas size based on actual video dimensions
                canvas.width = videoElement.videoWidth || 640;
                canvas.height = videoElement.videoHeight || 480;
                
                showNotification('Camera connected successfully! 📷');
                return true;
            } catch (error) {
                console.error('Camera error:', error);
                const cameraError = document.getElementById('cameraError');
                if (cameraError) {
                    cameraError.style.display = 'block';
                }
                showNotification('Failed to access camera: ' + error.message, 'error');
                return false;
            }
        }
        
        function captureAndSendFrame() {
            if (!videoElement || !canvas || !ctx || !isTrainingActive) return;
            
            try {
                // Check if video is actually playing
                if (videoElement.readyState < 2) return;
                
                const videoWidth = videoElement.videoWidth;
                const videoHeight = videoElement.videoHeight;
                
                if (videoWidth === 0 || videoHeight === 0) return;
                
                // Update canvas size if needed
                if (canvas.width !== videoWidth || canvas.height !== videoHeight) {
                    canvas.width = videoWidth;
                    canvas.height = videoHeight;
                }
                
                // Clear canvas first (iOS optimization)
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw video frame to canvas
                ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                
                // Convert to base64 with lower quality for iOS performance
                const frameData = canvas.toDataURL('image/jpeg', 0.4);
                
                // Send to backend via WebSocket
                socket.emit('process_frame', { frame: frameData });
            } catch (error) {
                console.log('Frame capture error:', error);
            }
        }
        
        function updateInstantFeedback(data) {
            // Update accuracy display immediately from frame processing
            const accuracyElement = document.getElementById('accuracyDisplay');
            if (accuracyElement) {
                accuracyElement.textContent = `${data.accuracy.toFixed(1)}%`;
                
                // Update accuracy color
                if (data.accuracy >= 65) {
                    accuracyElement.style.color = '#4ecdc4';
                } else if (data.accuracy >= 45) {
                    accuracyElement.style.color = '#ffa726';
                } else {
                    accuracyElement.style.color = '#ff6b6b';
                }
            }
            
            // Update status
            const statusElement = document.getElementById('statusText');
            if (statusElement) {
                statusElement.textContent = data.status;
            }
            
            // Visual feedback for hand detection - FIXED
            const videoElement = document.getElementById('videoElement');
            if (videoElement) {
                if (data.hand_detected) {
                    videoElement.style.border = data.accuracy >= 65 ? '3px solid #4ecdc4' : '3px solid #ffa726';
                } else {
                    videoElement.style.border = '3px solid #ff6b6b';
                }
            }
        }
        
        async function startTraining() {
            showNotification('Initializing training...', 'success');
            
            // First initialize camera
            const cameraSuccess = await initCamera();
            if (!cameraSuccess) {
                return;
            }
            
            // Then start training via WebSocket
            socket.emit('start_training');
        }
        
        function stopTraining() {
            socket.emit('stop_training');
        }
        
        function resetProgress() {
            if (confirm('Are you sure you want to reset all progress?')) {
                socket.emit('reset_progress');
            }
        }
    </script>
</body>
</html>